semantic_models:
  # --------------------------------------------------
  # 1. Orders (Fact) - 既存のもの
  # --------------------------------------------------
  - name: orders_semantic
    description: "注文データのセマンティックモデル"
    model: ref('orders')
    defaults:
      agg_time_dimension: ordered_at
    entities:
      - name: order_id
        type: primary
      - name: user_id
        type: foreign  # ★ここが結合キーになります
    dimensions:
      - name: ordered_at
        type: time
        type_params:
          time_granularity: day
      - name: status
        type: categorical
    measures:
      - name: revenue_sum
        description: "売上金額の合計"
        expr: revenue
        agg: sum

  # --------------------------------------------------
  # 2. Users (Dimension) - 新規追加
  # --------------------------------------------------
  - name: users_semantic
    description: "ユーザー属性データ"
    model: ref('users') # さっき作ったMartsを参照
    entities:
      - name: user_id
        type: primary  # ★ここがOrdersのForeignと結合されます
        expr: user_id
    dimensions:
      - name: country
        type: categorical
        description: "国"
      - name: age
        type: categorical
        description: "年齢"
      - name: gender
        type: categorical
        description: "性別"

  # --------------------------------------------------
  # 3. Time Spine (必須)
  # --------------------------------------------------
  - name: metricflow_time_spine
    model: ref('metricflow_time_spine')
    defaults:
      agg_time_dimension: date_day
    entities:
      - name: date_day_key
        type: primary
        expr: date_day
    dimensions:
      - name: date_day
        type: time
        type_params:
          time_granularity: day

metrics:
  - name: total_revenue
    label: "売上合計"
    description: "全期間の売上合計"
    type: simple
    type_params:
      measure: revenue_sum
  - name: revenue_mom_growth
    label: "売上_前月比(MoM)"
    description: "売上の前月比成長率"
    type: derived
    type_params:
      # 計算式でもエイリアス名を使う
      expr: (current_rev - prev_rev) / prev_rev
      metrics:
        - name: total_revenue
          alias: current_rev  # total_revenue ではなくユニークな名前をつける
        - name: total_revenue
          offset_window: 1 month
          alias: prev_rev     # ここは prev_rev とする